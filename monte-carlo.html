<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WindMar - Parametric Monte Carlo Simulation with Temporal Weather Correlation</title>
    <link rel="stylesheet" href="assets/css/docs.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>
</head>
<body>

<!-- Header -->
<header class="docs-header">
    <div class="docs-header-content">
        <a href="docs.html" class="docs-logo">
            <i class="fas fa-ship"></i>
            <span>WindMar</span>
        </a>
        <nav>
            <ul class="docs-nav">
                <li><a href="docs.html">Documentation</a></li>
                <li class="docs-nav-dropdown">
                    <a href="#">Technical Articles <i class="fas fa-caret-down"></i></a>
                    <ul class="docs-nav-dropdown-menu">
                        <li><a href="weather-fields.html">Weather Fields</a></li>
                        <li><a href="data-pipeline.html">Data Pipeline</a></li>
                        <li><a href="hydrodynamics.html">Hydrodynamics &amp; RAO</a></li>
                        <li><a href="astar-pathfinding.html">A* Pathfinding</a></li>
                        <li><a href="route-optimization-engines.html">Optimization Engines</a></li>
                        <li><a href="weather-data.html">Weather Acquisition</a></li>
                        <li><a href="monte-carlo.html" class="active">Monte Carlo</a></li>
                        <li><a href="open-problems.html">Open Problems</a></li>
                    </ul>
                </li>
                <li><a href="https://github.com/windmar-nav/windmar" target="_blank"><i class="fab fa-github"></i> GitHub</a></li>
                <li><a href="https://demo-windmar.slmar.co" target="_blank" class="demo-nav-link"><i class="fas fa-play-circle"></i> Live Demo</a></li>
            </ul>
        </nav>
        <a href="https://slmar.co" class="back-to-main"><i class="fas fa-arrow-left"></i> Back to Main Site</a>
    </div>
</header>

<!-- Main Layout -->
<div class="docs-container">

    <!-- Sidebar -->
    <aside class="docs-sidebar">

        <div class="sidebar-section">
            <div class="sidebar-title">Article</div>
            <ul class="sidebar-menu">
                <li><a href="#abstract"><i class="fas fa-file-alt"></i> Abstract</a></li>
                <li><a href="#introduction"><i class="fas fa-book-open"></i> Introduction</a></li>
                <li><a href="#literature"><i class="fas fa-graduation-cap"></i> Literature Review</a></li>
            </ul>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-title">Method</div>
            <ul class="sidebar-menu">
                <li><a href="#route-discretization"><i class="fas fa-ruler"></i> Route Discretization</a></li>
                <li><a href="#weather-prefetch"><i class="fas fa-database"></i> Weather Pre-fetch</a></li>
                <li><a href="#correlation-model"><i class="fas fa-project-diagram"></i> Correlation Model</a></li>
                <li><a href="#perturbation-model"><i class="fas fa-random"></i> Perturbation Model</a></li>
                <li><a href="#wind-wave-coupling"><i class="fas fa-link"></i> Wind&ndash;Wave Coupling</a></li>
            </ul>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-title">Implementation</div>
            <ul class="sidebar-menu">
                <li><a href="#algorithm"><i class="fas fa-code"></i> Algorithm</a></li>
                <li><a href="#performance"><i class="fas fa-tachometer-alt"></i> Performance</a></li>
                <li><a href="#limitations"><i class="fas fa-exclamation-circle"></i> Limitations</a></li>
            </ul>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-title">Resources</div>
            <ul class="sidebar-menu">
                <li><a href="#references"><i class="fas fa-bookmark"></i> References</a></li>
                <li><a href="docs.html#monte-carlo"><i class="fas fa-arrow-left"></i> Back to Docs</a></li>
                <li><a href="https://github.com/windmar-nav/windmar" target="_blank"><i class="fab fa-github"></i> GitHub</a></li>
            </ul>
        </div>

    </aside>

    <!-- Main Content -->
    <main class="docs-main">
        <div class="docs-content">

            <!-- ============================================================ -->
            <!-- ABSTRACT -->
            <!-- ============================================================ -->
            <section id="abstract">
                <h1>Parametric Monte Carlo Simulation with Temporal Weather Correlation</h1>
                <p class="docs-subtitle">A hybrid approach combining ensemble weather perturbation with time-varying forecast grids for maritime voyage uncertainty quantification</p>

                <div class="alert info">
                    <strong><i class="fas fa-info-circle"></i> Technical Article</strong><br>
                    This article describes the mathematical framework behind WindMar's Monte Carlo simulation engine.
                    It addresses the problem of quantifying fuel consumption and arrival time uncertainty for
                    ocean-going vessels subject to stochastic weather conditions along multi-day voyages.
                </div>

                <h3>Abstract</h3>
                <p>
                    Weather routing systems for commercial shipping typically produce a single deterministic
                    optimal route based on a single weather forecast. In practice, forecast uncertainty grows
                    with lead time and vessels encounter conditions that deviate from the forecast, making
                    deterministic ETA and fuel estimates unreliable for operational planning. This article presents
                    a parametric Monte Carlo method that hybridizes two approaches from the academic literature:
                    (1) temporally correlated stochastic perturbations applied to base weather fields, and
                    (2) ensemble-like multi-timestep weather sampling from pre-ingested forecast grids stored
                    in a database. The method produces P10/P50/P90 confidence intervals for ETA, fuel consumption,
                    and voyage time. The implementation runs 100 simulations in under 500 milliseconds by pre-fetching
                    weather data from compressed PostgreSQL grids and using Cholesky-decomposed correlation
                    matrices for efficient correlated random variate generation.
                </p>
            </section>

            <!-- ============================================================ -->
            <!-- INTRODUCTION -->
            <!-- ============================================================ -->
            <section id="introduction">
                <h2>1. Introduction</h2>

                <p>
                    Maritime weather routing aims to find the path and speed profile that minimizes fuel consumption
                    (or time, or a weighted combination) subject to safety constraints. The problem has been studied
                    extensively since Hanssen and James (1960) first applied dynamic programming to ocean routing.
                    Modern systems use numerical weather prediction (NWP) forecasts &mdash; typically from GFS, ECMWF,
                    or CMEMS &mdash; to compute wind, wave, and current conditions along candidate routes.
                </p>

                <p>
                    A fundamental limitation of deterministic routing is that NWP forecasts are uncertain.
                    Wind speed forecast errors grow roughly linearly with lead time: GFS 10-metre wind has
                    an RMS error of ~1.5 m/s at 24 hours, increasing to ~3.5 m/s at 120 hours. Significant
                    wave height errors follow a similar pattern. For a 5&ndash;7 day trans-oceanic voyage,
                    the weather encountered in the final days may differ substantially from the forecast
                    available at departure.
                </p>

                <p>
                    Two broad approaches exist in the literature for handling forecast uncertainty in ship routing:
                </p>

                <ol>
                    <li><strong>Ensemble-based methods</strong> &mdash; Use multiple NWP ensemble members (e.g., GEFS 30-member
                        ensemble, ECMWF 51-member ensemble) as distinct weather scenarios, optimizing a route for
                        each or computing statistics across the ensemble (Dickson et al., 2019; Mannarini et al., 2019).</li>
                    <li><strong>Parametric perturbation methods</strong> &mdash; Apply stochastic perturbations to a single
                        deterministic forecast, with the perturbation magnitude calibrated to match observed forecast
                        error statistics (Aijjou et al., 2021; Vettor &amp; Guedes Soares, 2016).</li>
                </ol>

                <p>
                    Each approach has trade-offs. Ensemble methods capture physically consistent weather patterns
                    but require downloading and processing 30&ndash;50 complete forecast fields per optimization
                    cycle, which is prohibitively expensive for real-time routing. Parametric methods are
                    computationally inexpensive but risk generating physically inconsistent weather scenarios
                    if perturbations are applied independently across time and space.
                </p>

                <p>
                    WindMar adopts a <strong>hybrid approach</strong> that combines elements of both:
                </p>
                <ul>
                    <li>Time-varying base weather from multi-timestep forecast grids (ensemble-like temporal variation)</li>
                    <li>Temporally correlated parametric perturbations (Cholesky-decomposed exponential correlation)</li>
                    <li>Cross-parameter coupling (wind&ndash;wave physical correlation)</li>
                </ul>

                <p>
                    This produces physically plausible weather scenarios at a fraction of the computational cost
                    of full ensemble routing, while maintaining temporal coherence that independent perturbations lack.
                </p>
            </section>

            <!-- ============================================================ -->
            <!-- LITERATURE REVIEW -->
            <!-- ============================================================ -->
            <section id="literature">
                <h2>2. Literature Review</h2>

                <h3>2.1 Ensemble Approaches</h3>
                <p>
                    Dickson et al. (2019) provide the most comprehensive treatment of uncertainty in marine weather
                    routing. They use the GEFS 30-member ensemble to generate 30 distinct weather scenarios, compute
                    optimal routes for each, and analyse the distribution of fuel consumption and arrival times.
                    Their key finding is that <em>route choice uncertainty</em> (which path is optimal) is often more
                    significant than <em>weather uncertainty along a fixed route</em>. However, they note that
                    ensemble-based routing is computationally expensive, requiring 30&times; the weather data
                    and computation of a deterministic system.
                </p>

                <p>
                    Mannarini et al. (2019) apply ensemble methods to the VISIR routing system, using ECMWF
                    ensemble forecasts for Mediterranean routing. They demonstrate that ensemble spread provides
                    a useful proxy for routing confidence and that routes optimised for the ensemble mean tend
                    to be more robust than routes optimised for the control forecast.
                </p>

                <h3>2.2 Parametric Perturbation Methods</h3>
                <p>
                    Aijjou et al. (2021) propose a comprehensive approach to weather uncertainty in ship route
                    optimization using Monte Carlo simulation with parametric perturbations. They apply
                    multiplicative factors to wind speed and wave height drawn from calibrated distributions,
                    and show that the resulting fuel consumption distributions closely match those obtained
                    from historical reanalysis data. A key contribution is their use of <em>correlated</em>
                    perturbations across weather parameters (e.g., wind and waves), reflecting the physical
                    relationship between wind forcing and sea state development.
                </p>

                <p>
                    Vettor and Guedes Soares (2016) study the impact of weather uncertainty on voluntary speed
                    reduction decisions, finding that wave height uncertainty is the dominant factor in fuel
                    consumption variance for laden tankers, while wind uncertainty dominates for container vessels
                    with high windage.
                </p>

                <h3>2.3 Temporal Correlation</h3>
                <p>
                    A critical insight from the meteorological literature is that forecast errors are
                    <em>temporally correlated</em>. If the forecast underestimates wind speed at hour 12 of a
                    voyage, it is very likely to also underestimate wind speed at hour 15, because the same
                    synoptic-scale weather system persists. The decorrelation time scale is on the order of
                    1&ndash;3 days for mid-latitude synoptic systems (Holton &amp; Hakim, 2013).
                </p>

                <p>
                    Papers on wind power forecasting uncertainty (e.g., Pinson &amp; Madsen, 2012) have long
                    used temporally correlated perturbation models for wind speed, typically with exponential
                    or Gaussian correlation kernels. The maritime routing literature has been slower to adopt
                    this approach, with most parametric methods applying independent perturbations per leg
                    or per time step.
                </p>

                <h3>2.4 Gap Addressed</h3>
                <p>
                    The approach implemented in WindMar bridges several gaps in the existing literature:
                </p>
                <ul>
                    <li>Temporal correlation of perturbations (following wind power literature, applied to ship routing)</li>
                    <li>Cross-parameter coupling (wind&ndash;wave correlation, following Aijjou et al.)</li>
                    <li>Time-varying base weather from multi-timestep forecast grids (following ensemble spirit, but from a single deterministic forecast at multiple lead times)</li>
                    <li>Computational efficiency enabling real-time use (100 simulations &lt; 500ms)</li>
                </ul>
            </section>

            <!-- ============================================================ -->
            <!-- ROUTE DISCRETIZATION -->
            <!-- ============================================================ -->
            <section id="route-discretization">
                <h2>3. Route Discretization</h2>

                <p>
                    The voyage route is discretized into <em>n</em> time slices, evenly spaced along the
                    route duration. The number of slices adapts to the voyage length:
                </p>

                <div class="formula-block">
                    <div class="formula-title">Number of Time Slices</div>
\[ n = \min\!\bigl(100,\; \max(20,\; \lfloor T / 1.2 \rfloor)\bigr) \]
<div class="formula-where">
where \( T \) is the estimated voyage duration in hours<br>
(\( T = \text{total\_distance} / \text{calm\_speed} \))
</div>
                </div>

                <p>
                    This produces approximately one slice per 1.2 hours, capped at 100 slices for computational
                    efficiency. For a typical 5-day MR tanker voyage (~120 hours), this yields 100 slices.
                    For a short coastal voyage (~24 hours), 20 slices.
                </p>

                <p>
                    Each slice <em>i</em> has:
                </p>
                <ul>
                    <li><strong>Timestamp</strong> t<sub>i</sub> = departure + (i / (n-1)) &times; T</li>
                    <li><strong>Position</strong> (lat<sub>i</sub>, lon<sub>i</sub>) via linear interpolation along the cumulative distance table of the route legs</li>
                </ul>

                <p>
                    The interpolation follows rhumb-line segments between waypoints, consistent with the
                    voyage calculator's leg geometry.
                </p>
            </section>

            <!-- ============================================================ -->
            <!-- WEATHER PRE-FETCH -->
            <!-- ============================================================ -->
            <section id="weather-prefetch">
                <h2>4. Weather Pre-fetch from Forecast Grids</h2>

                <p>
                    A distinguishing feature of this implementation is the use of <strong>pre-ingested multi-timestep
                    forecast grids</strong> stored in PostgreSQL. Rather than using a single weather snapshot for
                    all time slices, the simulator loads wave forecast data at multiple forecast hours
                    (0, 3, 6, &hellip;, 120h) and selects the appropriate forecast hour for each time slice.
                </p>

                <h3>4.1 Data Sources per Slice</h3>
                <table>
                    <thead>
                        <tr><th>Parameter</th><th>Source</th><th>Temporal Resolution</th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Wave height (Hs), period (Tp), direction</td>
                            <td>DB grids (CMEMS wave forecast)</td>
                            <td>3-hourly, nearest forecast hour</td>
                        </tr>
                        <tr>
                            <td>Current speed, direction</td>
                            <td>DB grid (CMEMS current analysis)</td>
                            <td>Single snapshot (analysis time)</td>
                        </tr>
                        <tr>
                            <td>Wind speed, direction</td>
                            <td>GridWeatherProvider (GFS, pre-fetched)</td>
                            <td>Nearest leg midpoint</td>
                        </tr>
                    </tbody>
                </table>

                <h3>4.2 Forecast Hour Selection</h3>
                <p>
                    For each time slice with timestamp t<sub>i</sub>, the simulator computes the offset from
                    the forecast run time and selects the closest available forecast hour:
                </p>

                <div class="formula-block">
                    <div class="formula-title">Forecast Hour Matching</div>
\[ \Delta h = \frac{t_i - t_{\text{run}}}{3600} \]
\[ fh_{\text{best}} = \operatorname*{argmin}_{fh \,\in\, \text{available\_hours}} |fh - \Delta h| \]
                </div>

                <p>
                    This means a voyage departing 6 hours after the latest forecast run will use forecast hour
                    f006 for its first slices and f120 for slices ~114 hours later. The base weather thus
                    naturally varies along the route, reflecting the forecast model's prediction of how
                    conditions will evolve &mdash; a form of <em>implicit ensemble sampling</em> from a single
                    deterministic forecast at different lead times.
                </p>

                <h3>4.3 Bilinear Interpolation</h3>
                <p>
                    Weather values at each slice position are obtained via bilinear interpolation from the
                    forecast grid. The <code>GridWeatherProvider._interp()</code> static method performs
                    nearest-neighbour index lookup followed by bilinear weighting:
                </p>

                <div class="formula-block">
                    <div class="formula-title">Bilinear Interpolation</div>
<div class="formula-where">
Given grid point \( (\text{lat}, \text{lon}) \) and surrounding grid cells:<br>
\( (\text{lat}_0, \text{lon}_0) \), \( (\text{lat}_0, \text{lon}_1) \), \( (\text{lat}_1, \text{lon}_0) \), \( (\text{lat}_1, \text{lon}_1) \)
</div>
\[ f_{\text{lat}} = \frac{\text{lat} - \text{lat}_0}{\text{lat}_1 - \text{lat}_0} \qquad f_{\text{lon}} = \frac{\text{lon} - \text{lon}_0}{\text{lon}_1 - \text{lon}_0} \]
\[ v = (1 - f_{\text{lat}})(1 - f_{\text{lon}})\,v_{00} + (1 - f_{\text{lat}})\,f_{\text{lon}}\,v_{01} + f_{\text{lat}}(1 - f_{\text{lon}})\,v_{10} + f_{\text{lat}}\,f_{\text{lon}}\,v_{11} \]
                </div>

                <p>
                    This runs in microseconds per point, enabling 100 &times; 100 = 10,000 weather lookups
                    (100 simulations &times; ~100 slices queried by the voyage calculator) without measurable
                    overhead.
                </p>
            </section>

            <!-- ============================================================ -->
            <!-- CORRELATION MODEL -->
            <!-- ============================================================ -->
            <section id="correlation-model">
                <h2>5. Temporal Correlation Model</h2>

                <p>
                    The central innovation of this implementation is the use of <strong>temporally correlated
                    perturbations</strong> via Cholesky decomposition of an exponential correlation matrix.
                    This ensures that weather perturbations at nearby time slices are strongly correlated,
                    producing physically plausible weather evolution within each simulation.
                </p>

                <h3>5.1 Exponential Correlation Kernel</h3>
                <p>
                    The correlation between perturbations at time slices <em>i</em> and <em>j</em> is modeled
                    by an exponential kernel:
                </p>

                <div class="formula-block">
                    <div class="formula-title">Correlation Matrix</div>
\[ C_{ij} = \exp\!\Bigl(-\frac{|t_i - t_j|}{\tau}\Bigr) \]
<div class="formula-where">
where \( t \in [0, 1] \) is normalized time along the voyage<br>
\( \tau = 0.3 \) (correlation length parameter)
</div>
                </div>

                <p>
                    The choice of &tau; = 0.3 corresponds to a decorrelation time of ~30% of the voyage
                    duration. For a 5-day (120-hour) voyage, this is ~36 hours, consistent with the
                    characteristic lifetime of mid-latitude synoptic systems (1&ndash;3 days).
                </p>

                <h3>5.2 Cholesky Decomposition</h3>
                <p>
                    The correlation matrix C is decomposed into its lower-triangular Cholesky factor:
                </p>

                <div class="formula-block">
                    <div class="formula-title">Cholesky Factorization</div>
\[ C = L \cdot L^T \]
<div class="formula-where">
where \( L \) is lower-triangular (computed once per simulation batch)<br><br>
A small diagonal regularization (\( 10^{-8} \cdot I \)) is added for numerical stability of the decomposition.
</div>
                </div>

                <p>
                    Correlated standard normal variates are then generated as:
                </p>

                <div class="formula-block">
                    <div class="formula-title">Correlated Variate Generation</div>
\[ \mathbf{z} = L \cdot \boldsymbol{\varepsilon}, \qquad \boldsymbol{\varepsilon} \sim \mathcal{N}(\mathbf{0}, I_n) \]
<div class="formula-where">
where \( \boldsymbol{\varepsilon} \) is a vector of \( n \) independent standard normals<br>
and \( \mathbf{z} \) has the desired correlation structure: \( \mathbb{E}[\mathbf{z}\,\mathbf{z}^T] = C \)
</div>
                </div>

                <p>
                    This is computationally efficient: the Cholesky decomposition (O(n&sup3;)) is computed once
                    for the entire batch of simulations, and each simulation only requires a matrix-vector
                    multiplication (O(n&sup2;)), which for n = 100 takes microseconds.
                </p>

                <h3>5.3 Physical Interpretation</h3>
                <p>
                    The exponential kernel produces perturbation sequences where:
                </p>
                <ul>
                    <li>Adjacent slices (1.2h apart) have correlation &asymp; 0.96 &mdash; nearly identical perturbation</li>
                    <li>Slices 12h apart have correlation &asymp; 0.67 &mdash; similar but diverging</li>
                    <li>Slices 36h apart have correlation &asymp; 0.37 &mdash; moderately correlated</li>
                    <li>Slices 72h apart have correlation &asymp; 0.14 &mdash; nearly independent</li>
                </ul>
                <p>
                    This means that if simulation #42 experiences a wind perturbation factor of 1.4 at hour 24,
                    it will likely experience ~1.35 at hour 27 and ~1.2 at hour 36, but might experience 0.9
                    at hour 96. This temporal coherence is critical for producing realistic fuel consumption
                    distributions &mdash; a simulation where wind is alternately high and low every few hours
                    would underestimate variance.
                </p>
            </section>

            <!-- ============================================================ -->
            <!-- PERTURBATION MODEL -->
            <!-- ============================================================ -->
            <section id="perturbation-model">
                <h2>6. Perturbation Model</h2>

                <p>
                    Weather parameters are perturbed using multiplicative factors drawn from log-normal
                    distributions (for positive quantities like speed and height) and additive Gaussian offsets
                    (for directions).
                </p>

                <h3>6.1 Log-Normal Multiplicative Factors</h3>
                <p>
                    For wind speed, wave height, and current speed, the perturbation factor is:
                </p>

                <div class="formula-block">
                    <div class="formula-title">Log-Normal Perturbation Factor</div>
\[ f = \exp\!\bigl(\sigma \cdot z - \tfrac{1}{2}\sigma^2\bigr) \]
<div class="formula-where">
where \( z \) is a correlated standard normal (from Section 5)<br>
and \( \sigma \) is the parameter-specific log-normal sigma<br><br>
This ensures \( \mathbb{E}[f] = 1 \) (unbiased perturbation) and the distribution is right-skewed (occasional large values, bounded below by zero).
</div>
                </div>

                <h3>6.2 Parameter-Specific Sigmas</h3>

                <table>
                    <thead>
                        <tr><th>Parameter</th><th>&sigma;</th><th>Approx. 90% range</th><th>Justification</th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Wind speed</td>
                            <td>0.35</td>
                            <td>[0.56, 1.59]</td>
                            <td>GFS 10m wind RMS error ~2&ndash;3.5 m/s at 24&ndash;120h lead time (Hamill et al., 2006)</td>
                        </tr>
                        <tr>
                            <td>Wave height</td>
                            <td>0.20</td>
                            <td>[0.72, 1.32]</td>
                            <td>CMEMS Hs bias ~0.1&ndash;0.3m, scatter ~20% (Bidlot et al., 2019)</td>
                        </tr>
                        <tr>
                            <td>Current speed</td>
                            <td>0.15</td>
                            <td>[0.78, 1.24]</td>
                            <td>CMEMS currents are analysis products with lower uncertainty than forecasts</td>
                        </tr>
                        <tr>
                            <td>Directions</td>
                            <td>15&deg;</td>
                            <td>[&minus;25&deg;, +25&deg;]</td>
                            <td>Typical directional error for wind and waves (Cardone &amp; Ceccacci, 2019)</td>
                        </tr>
                    </tbody>
                </table>

                <p>
                    Wind has the largest sigma (&sigma; = 0.35) because GFS forecast errors grow significantly
                    with lead time, and wind resistance is the dominant weather penalty for laden tankers
                    (Blendermann wind resistance model). Wave height has a smaller sigma (&sigma; = 0.20) because
                    wave models assimilate altimetry data and exhibit lower relative errors than wind forecasts
                    at the same lead time.
                </p>

                <h3>6.3 Direction Perturbations</h3>
                <p>
                    Wind and wave directions are perturbed by additive Gaussian offsets with &sigma; = 15&deg;,
                    temporally correlated using the same Cholesky mechanism:
                </p>

                <div class="formula-block">
                    <div class="formula-title">Direction Perturbation</div>
\[ \text{dir}' = (\text{dir} + \sigma_{\text{dir}} \cdot z_{\text{dir}}) \bmod 360° \]
<div class="formula-where">
where \( z_{\text{dir}} \) is a temporally correlated standard normal<br>
and \( \sigma_{\text{dir}} = 15° \)
</div>
                </div>
            </section>

            <!-- ============================================================ -->
            <!-- WIND-WAVE COUPLING -->
            <!-- ============================================================ -->
            <section id="wind-wave-coupling">
                <h2>7. Wind&ndash;Wave Coupling</h2>

                <p>
                    In the real ocean, waves are driven by wind. An increase in wind speed leads to increased
                    wave height after a development time that depends on fetch and duration. The perturbation
                    model captures this physical relationship by making the wave height perturbation partially
                    correlated with the wind speed perturbation.
                </p>

                <div class="formula-block">
                    <div class="formula-title">Wind&ndash;Wave Coupled Perturbation</div>
\[ z_{\text{wave}} = \rho \cdot z_{\text{wind}} + \sqrt{1 - \rho^2} \cdot z_{\text{wave,indep}} \]
<div class="formula-where">
where \( \rho = 0.7 \) (wind&ndash;wave correlation coefficient)<br><br>
This gives:<br>
\( \text{Var}(z_{\text{wave}}) = \rho^2 + (1 - \rho^2) = 1 \)<br>
\( \text{Corr}(z_{\text{wave}}, z_{\text{wind}}) = \rho = 0.7 \)
</div>
                </div>

                <p>
                    The correlation coefficient &rho; = 0.7 means that 49% of wave height variance is explained
                    by wind speed variance, with the remaining 51% from independent factors (swell from remote
                    storms, local bathymetric effects, wave model biases). This value is consistent with
                    observational studies of the wind&ndash;sea relationship in open ocean conditions
                    (Hasselmann et al., 1973; Young, 1999).
                </p>

                <p>
                    The coupling ensures that simulations where the vessel encounters higher-than-forecast winds
                    also tend to experience higher-than-forecast waves, producing realistic combined resistance
                    penalties. Without this coupling, the Monte Carlo would underestimate the variance of fuel
                    consumption because high-wind and high-wave events would occur independently instead of
                    together.
                </p>
            </section>

            <!-- ============================================================ -->
            <!-- ALGORITHM -->
            <!-- ============================================================ -->
            <section id="algorithm">
                <h2>8. Algorithm</h2>

                <p>
                    The complete Monte Carlo simulation proceeds as follows:
                </p>

                <h3>8.1 Pre-computation (once per batch)</h3>
                <ol>
                    <li>Discretize route into <em>n</em> time slices with timestamps and positions</li>
                    <li>Pre-fetch base weather for all slices (DB wave grids + GFS wind + CMEMS current)</li>
                    <li>Compute Cholesky factor L of the n &times; n exponential correlation matrix</li>
                </ol>

                <h3>8.2 Per-simulation loop (N = 100 times)</h3>
                <ol>
                    <li>Generate 4 independent standard normal vectors: &epsilon;<sub>wind</sub>, &epsilon;<sub>wave,indep</sub>, &epsilon;<sub>current</sub>, &epsilon;<sub>dir</sub></li>
                    <li>Multiply each by L to obtain temporally correlated normals: z = L &middot; &epsilon;</li>
                    <li>Apply wind&ndash;wave coupling: z<sub>wave</sub> = 0.7 z<sub>wind</sub> + 0.714 z<sub>wave,indep</sub></li>
                    <li>Convert to perturbation factors: f = exp(&sigma; z - &frac12;&sigma;&sup2;)</li>
                    <li>Build perturbed weather provider callable:
                        <ul>
                            <li>For each query (lat, lon, time), find the nearest time slice (top-5 by time, then nearest spatially)</li>
                            <li>Return base weather at that slice, multiplied by the slice's perturbation factors</li>
                        </ul>
                    </li>
                    <li>Run full voyage calculation with the perturbed weather provider</li>
                    <li>Collect total_time, total_fuel, arrival_time</li>
                </ol>

                <h3>8.3 Post-processing</h3>
                <ol>
                    <li>Compute 10th, 50th, 90th percentiles of fuel, time, and arrival arrays</li>
                    <li>Return <code>MonteCarloResult</code> with P10/P50/P90 confidence intervals</li>
                </ol>

                <h3>8.4 Weather Provider Matching</h3>
                <p>
                    The perturbed weather provider maps each voyage calculator query to the nearest pre-computed
                    time slice using a two-stage nearest-neighbour search:
                </p>
                <ol>
                    <li>Find the 5 slices closest in time (using pre-computed timestamps as a numpy array)</li>
                    <li>Among those 5, select the one closest spatially (Euclidean distance in lat/lon space)</li>
                </ol>
                <p>
                    This hybrid time-space matching handles the case where the voyage calculator queries
                    leg midpoints that don't exactly coincide with the pre-computed slice positions.
                </p>
            </section>

            <!-- ============================================================ -->
            <!-- PERFORMANCE -->
            <!-- ============================================================ -->
            <section id="performance">
                <h2>9. Performance</h2>

                <h3>9.1 Computational Cost Breakdown</h3>
                <table>
                    <thead>
                        <tr><th>Stage</th><th>Time</th><th>Notes</th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Route discretization</td>
                            <td>&lt; 1ms</td>
                            <td>Simple arithmetic, n &le; 100</td>
                        </tr>
                        <tr>
                            <td>Weather pre-fetch (DB)</td>
                            <td>50&ndash;150ms</td>
                            <td>PostgreSQL query + zlib decompress + bilinear interpolation</td>
                        </tr>
                        <tr>
                            <td>Cholesky decomposition</td>
                            <td>&lt; 1ms</td>
                            <td>100 &times; 100 matrix, numpy LAPACK backend</td>
                        </tr>
                        <tr>
                            <td>100 simulations</td>
                            <td>200&ndash;350ms</td>
                            <td>~2&ndash;3.5ms per simulation (perturbation generation + voyage calc)</td>
                        </tr>
                        <tr>
                            <td>Percentile computation</td>
                            <td>&lt; 1ms</td>
                            <td>numpy.percentile on arrays of length 100</td>
                        </tr>
                        <tr>
                            <td><strong>Total</strong></td>
                            <td><strong>300&ndash;500ms</strong></td>
                            <td>For 100 simulations of a 5-day voyage</td>
                        </tr>
                    </tbody>
                </table>

                <h3>9.2 Scaling</h3>
                <p>
                    The simulation scales linearly with the number of simulations and linearly with the
                    number of route legs. The weather pre-fetch is amortized across all simulations and is
                    the dominant fixed cost. Doubling the number of simulations from 100 to 200 adds ~250ms.
                </p>

                <h3>9.3 Comparison with Live Weather</h3>
                <p>
                    Without the pre-ingested weather database, each simulation would need to query weather
                    at each slice position via the unified weather provider, which triggers live CMEMS/GFS API
                    calls. In testing, this took <strong>78.5 seconds for 50 simulations</strong> (~1.6s per simulation,
                    dominated by HTTP latency). The database pre-fetch architecture achieved a
                    <strong>200&times; speedup</strong>.
                </p>
            </section>

            <!-- ============================================================ -->
            <!-- LIMITATIONS -->
            <!-- ============================================================ -->
            <section id="limitations">
                <h2>10. Limitations and Future Work</h2>

                <h3>10.1 Current Limitations</h3>
                <ul>
                    <li><strong>No spatial correlation</strong> &mdash; Perturbations are correlated in time but
                        not in space. A proper spatial correlation model would require 2D random fields
                        (e.g., Mat&eacute;rn covariance), significantly increasing computational cost.</li>
                    <li><strong>Isotropic perturbations</strong> &mdash; The same perturbation magnitude is applied
                        regardless of geographic region. In practice, forecast skill varies by region
                        (better in data-rich areas, worse in the Southern Ocean).</li>
                    <li><strong>Fixed sigma values</strong> &mdash; The perturbation sigmas are constant across
                        forecast lead times. In reality, forecast error grows with lead time; an adaptive sigma
                        schedule would improve realism.</li>
                    <li><strong>Single forecast scenario</strong> &mdash; The base weather comes from a single
                        deterministic forecast (best available). Using actual NWP ensemble members would
                        capture physically consistent large-scale pattern uncertainty that parametric
                        perturbations cannot.</li>
                    <li><strong>Time-invariant ETA in mild weather</strong> &mdash; The voyage calculator only
                        reduces speed when required power exceeds 90% MCR. In mild weather (e.g., Mediterranean
                        summer), engine power is sufficient to maintain commanded speed, producing zero ETA
                        variance. Only fuel consumption varies.</li>
                </ul>

                <h3>10.2 Future Improvements</h3>
                <ul>
                    <li><strong>Lead-time-dependent sigma</strong> &mdash; Scale perturbation magnitude with
                        forecast lead time: &sigma;(t) = &sigma;<sub>0</sub> &middot; (1 + &alpha; &middot; t/T),
                        calibrated against GFS/CMEMS verification statistics.</li>
                    <li><strong>NWP ensemble integration</strong> &mdash; When available, use GEFS or ECMWF
                        ensemble members as base weather scenarios instead of parametric perturbations.</li>
                    <li><strong>Spatial correlation via Mat&eacute;rn fields</strong> &mdash; Generate spatially
                        correlated perturbation fields for routes that span multiple weather regimes.</li>
                    <li><strong>Adaptive grid resolution</strong> &mdash; Increase slice density in regions
                        of high weather gradient (e.g., near frontal zones) and decrease in stable regions.</li>
                </ul>
            </section>

            <!-- ============================================================ -->
            <!-- REFERENCES -->
            <!-- ============================================================ -->
            <section id="references">
                <h2>References</h2>

                <ol>
                    <li>
                        Aijjou, A.E., Bahaj, M., and Wakrime, A. (2021).
                        &ldquo;A Comprehensive Approach to Account for Weather Uncertainties in Ship Route Optimization.&rdquo;
                        <em>Journal of Marine Science and Engineering</em>, 9(12):1434.
                        DOI: 10.3390/jmse9121434
                    </li>
                    <li>
                        Dickson, T., Farr, H., Sear, D., and Blake, J. (2019).
                        &ldquo;Uncertainty in marine weather routing.&rdquo;
                        <em>arXiv preprint</em>, arXiv:1901.03840.
                    </li>
                    <li>
                        Hamill, T.M., Whitaker, J.S., and Wei, X. (2004).
                        &ldquo;Ensemble Reforecasting: Improving Medium-Range Forecast Skill Using Retrospective Forecasts.&rdquo;
                        <em>Monthly Weather Review</em>, 132(6):1434&ndash;1447.
                    </li>
                    <li>
                        Hanssen, G.L. and James, R.W. (1960).
                        &ldquo;Optimum ship routing.&rdquo;
                        <em>Journal of Navigation</em>, 13(3):253&ndash;272.
                    </li>
                    <li>
                        Hasselmann, K. et al. (1973).
                        &ldquo;Measurements of wind-wave growth and swell decay during the Joint North Sea Wave Project (JONSWAP).&rdquo;
                        <em>Erg&auml;nzungsheft zur Deutschen Hydrographischen Zeitschrift</em>, Reihe A, Nr. 12.
                    </li>
                    <li>
                        Holton, J.R. and Hakim, G.J. (2013).
                        <em>An Introduction to Dynamic Meteorology</em>, 5th edition.
                        Academic Press.
                    </li>
                    <li>
                        Mannarini, G. and Carelli, L. (2019).
                        &ldquo;VISIR-1.b: Ocean surface gravity waves and currents for energy-efficient navigation.&rdquo;
                        <em>Geoscientific Model Development</em>, 12:3449&ndash;3480.
                    </li>
                    <li>
                        Pinson, P. and Madsen, H. (2012).
                        &ldquo;Adaptive modelling and forecasting of offshore wind power fluctuations with Markov-switching autoregressive models.&rdquo;
                        <em>Journal of Forecasting</em>, 31(4):281&ndash;313.
                    </li>
                    <li>
                        Vettor, R. and Guedes Soares, C. (2016).
                        &ldquo;Development of a ship weather routing system.&rdquo;
                        <em>Ocean Engineering</em>, 123:1&ndash;14.
                    </li>
                    <li>
                        Young, I.R. (1999).
                        <em>Wind Generated Ocean Waves</em>.
                        Elsevier Ocean Engineering Book Series, Vol. 2.
                    </li>
                </ol>

                <h3>Further Reading</h3>
                <ol>
                    <li>
                        Nielsen, U.D. et al.
                        &ldquo;Wave Estimation and Forecasting Using Ships as Wave Buoys.&rdquo;
                        DTU Mechanical Engineering, Technical University of Denmark.
                        <a href="https://orbit.dtu.dk/en/projects/wave-estimation-and-forecasting-using-ships-as-wave-buoys/" target="_blank">orbit.dtu.dk</a>
                    </li>
                    <li>
                        Heikkil&auml;, M. et al.
                        &ldquo;Improving the Global Predictions of Shipping Emission by Modelling the Effects of Ambient Conditions.&rdquo;
                        In: <em>Air Pollution Modeling and its Application XXIX</em>, Springer, 2025.
                        DOI: 10.1007/978-3-031-70424-6_34
                    </li>
                    <li>
                        ITTC (2021).
                        &ldquo;Recommended Procedures and Guidelines 7.5&ndash;02&ndash;02&ndash;04: Wave Profile Measurement and Wave Pattern Resistance Analysis.&rdquo;
                        International Towing Tank Conference.
                        <a href="https://www.ittc.info/media/9605/75-02-02-04.pdf" target="_blank">ittc.info</a>
                    </li>
                </ol>
            </section>

        </div>
    </main>

</div>

<!-- Footer -->
<footer class="docs-footer">
    <p>&copy; 2026 WindMar. Apache License 2.0.</p>
    <p>
        <a href="https://github.com/windmar-nav/windmar" target="_blank"><i class="fab fa-github"></i> GitHub</a>
        &nbsp;|&nbsp;
        <a href="docs.html">Main Documentation</a>
        &nbsp;|&nbsp;
        <a href="https://slmar.co">slmar.co</a>
    </p>
</footer>

<!-- Sidebar active state script -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const sections = document.querySelectorAll('section[id]');
        const navLinks = document.querySelectorAll('.sidebar-menu a[href^="#"]');

        function setActiveLink() {
            let current = '';
            sections.forEach(function(section) {
                const sectionTop = section.offsetTop - 100;
                if (window.scrollY >= sectionTop) {
                    current = section.getAttribute('id');
                }
            });

            navLinks.forEach(function(link) {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + current) {
                    link.classList.add('active');
                }
            });
        }

        window.addEventListener('scroll', setActiveLink);
        setActiveLink();
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        renderMathInElement(document.body, {
            delimiters: [
                {left: '\\[', right: '\\]', display: true},
                {left: '\\(', right: '\\)', display: false}
            ],
            throwOnError: false
        });
    });
</script>

</body>
</html>
